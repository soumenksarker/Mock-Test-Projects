REM   Script: SQL_Challenge
REM   GREAT

CREATE TABLE customers  
  (  
    customer_id NUMBER   
                GENERATED BY DEFAULT AS IDENTITY START WITH 101  
                PRIMARY KEY,  
    name         VARCHAR2( 255 ) NOT NULL  
   );

CREATE TABLE products  
  (  
    product_id NUMBER   
               GENERATED BY DEFAULT AS IDENTITY START WITH 11  
               PRIMARY KEY,  
    product_name  VARCHAR2( 255 ) NOT NULL);

CREATE TABLE orders 
  (order_id VARCHAR(20), 
  PRIMARY KEY (order_id), 
    customer_id NUMBER( 6, 0 ) NOT NULL, -- fk 
    status      VARCHAR( 20 ) NOT NULL , 
    order_date  DATE NOT NULL, 
    CONSTRAINT fk_orders_customers  
      FOREIGN KEY( customer_id ) 
      REFERENCES customers( customer_id ) 
      ON DELETE CASCADE);

CREATE TABLE order_items 
  ( 
    order_id VARCHAR(20), -- pk 
    item_id    NUMBER( 12, 0 ), 
    product_id NUMBER( 12, 0 ) NOT NULL, --pk 
    quantity   NUMBER( 8, 2 ) 
      );

Insert into CUSTOMERS (CUSTOMER_ID,NAME) values (101,'Ben Franklin');

Insert into CUSTOMERS (CUSTOMER_ID,NAME) values (234,'Walmart');

Insert into CUSTOMERS (CUSTOMER_ID,NAME) values (998,'Target');

Insert into CUSTOMERS (CUSTOMER_ID,NAME) values (6751,'Camping Supply');

Insert into CUSTOMERS (CUSTOMER_ID,NAME) values (7787,'Up North Supply');

Insert into CUSTOMERS (CUSTOMER_ID,NAME) values (2314,'Corner Drug');

Insert into CUSTOMERS (CUSTOMER_ID,NAME) values (9832,'Menards');

Insert into CUSTOMERS (CUSTOMER_ID,NAME) values (9876,'Home Depot');

Insert into CUSTOMERS (CUSTOMER_ID,NAME) values (1209,'Acme Store');

Insert into CUSTOMERS (CUSTOMER_ID,NAME) values (1322,'Camping Outfitters');

Insert into PRODUCTS (PRODUCT_ID,PRODUCT_NAME) values (11,'4 person tent');

Insert into PRODUCTS (PRODUCT_ID,PRODUCT_NAME) values (23,'2 person tent');

Insert into PRODUCTS (PRODUCT_ID,PRODUCT_NAME) values (26,'camping stove(small)');

Insert into PRODUCTS (PRODUCT_ID,PRODUCT_NAME) values (46,'camping stove(large)');

Insert into PRODUCTS (PRODUCT_ID,PRODUCT_NAME) values (55,'flashlight');

Insert into PRODUCTS (PRODUCT_ID,PRODUCT_NAME) values (61,'sleeping bag');

Insert into PRODUCTS (PRODUCT_ID,PRODUCT_NAME) values (72,'coffee pot');

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('1432aa76e9',998,'open',to_date('19-APR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('37287dj3ec2',234,'open',to_date('19-APR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('87bhd76873',101,'open',to_date('19-APR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('638gje9b3s',2314,'in process',to_date('15-APR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('9843jeb2di3',9832,'in process',to_date('14-APR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('28349bae83',6751,'fulfilled',to_date('14-APR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('54938fealbe',9876,'fulfilled',to_date('14-APR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('9ir4tpi4s44',998,'fulfilled',to_date('13-APR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('43q9t4ba43',7787,'fulfilled',to_date('12-APR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('1243kbek44',234,'fulfilled',to_date('9-APR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('32239br4t98',1209,'fulfilled',to_date('8-APR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('5430t4br412',1322,'fulfilled',to_date('8-APR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('221948bfe4',998,'fulfilled',to_date('6-APR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('767763h38g',998,'canceled',to_date('31-MAR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('15983vibe4',1209,'fulfilled',to_date('31-MAR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('89823bj4g88',6751,'fulfilled',to_date('29-MAR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('98743grj3g4',998,'fulfilled',to_date('29-MAR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('64345dfew4',2314,'fulfilled',to_date('25-MAR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('74353r3b43',9832,'fulfilled',to_date('25-MAR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('45754g3wq4',1209,'back ordered',to_date('24-MAR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('3455fhcw45',101,'fulfilled',to_date('23-MAR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('49683vbjnr2',7787,'back ordered',to_date('23-MAR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('5b4i4ain441',9876,'fulfilled',to_date('22-MAR-21','DD-MON-RR'));

Insert into ORDERS (ORDER_ID,CUSTOMER_ID,STATUS,ORDER_DATE) values ('632hn48n4s',998,'canceled',to_date('22-MAR-21','DD-MON-RR'));

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('1243kbek44',11,6);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('1243kbek44',23,12);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('1432aa76e9',55,30);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('15983vibe4',11,10);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('15983vibe4',46,8);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('221948bfe4',61,6);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('221948bfe4',72,10);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('221948bfe4',55,30);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID) values ('235bri3434',72);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('235bri3434',55,20);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('28349bae83',11,2);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('28349bae83',23,4);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('28349bae83',61,6);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('32239br4t98',61,8);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('32239br4t98',72,10);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('32239br4t98',52,20);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('3455fhcw45',23,4);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('3455fhcw45',46,8);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('3455fhcw45',55,35);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('37287dj3ec2',11,4);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('37287dj3ec2',23,2);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('37287dj3ec2',72,8);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('43q9t4ba43',72,6);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('43q9t4ba43',55,12);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('43q9t4ba43',23,2);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('45754g3wq4',26,10);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('49683vbjnr2',26,15);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('5430t4br412',11,20);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('5430t4br412',23,12);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('5430t4br412',61,10);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('54938fealbe',61,12);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('54938fealbe',72,12);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('54938fealbe',11,12);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('5b4i4ain441',55,18);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('632hn48n4s',23,8);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('632hn48n4s',11,10);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('632hn48n4s',61,12);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('632hn48n4s',72,12);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('632hn48n4s',55,24);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('638gje9b3s',46,12);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('638gje9b3s',23,6);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('638gje9b3s',72,18);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('64345dfew4',55,24);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('64345dfew4',72,5);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('64345dfew4',61,14);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('74353r3b43',55,30);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('74353r3b43',61,5);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('74353r3b43',23,4);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('767763h38g',23,3);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('767763h38g',46,10);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('767763h38g',61,14);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('87bhd76873',11,10);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('87bhd76873',23,3);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('89823bj4g88',11,4);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('89823bj4g88',46,8);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('9843jeb2di3',55,15);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('9843jeb2di3',61,10);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('9843jeb2di3',23,12);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('9843jeb2di3',11,2);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('98743grj3g4',61,8);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('98743grj3g4',55,20);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('9ir4tpi4s44',11,20);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('9ir4tpi4s44',23,6);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('9ir4tpi4s44',61,10);

Insert into ORDER_ITEMS (ORDER_ID,PRODUCT_ID,QUANTITY) values ('9ir4tpi4s44',55,20);

SELECT customer_id, COUNT(DISTINCT order_id) AS numberOfOrders 
FROM orders 
GROUP BY customer_id;

SELECT customer_id, COUNT(DISTINCT order_id) as numoforders, round(count(DISTINCT product_id)/COUNT(DISTINCT order_id)) as avgnumprod 
FROM orders 
INNER JOIN order_items 
       USING(order_id) 
GROUP BY customer_id;

SELECT * FROM (SELECT count(product_id) as num_of_items, product_id, customer_id  
FROM orders 
Left JOIN order_items 
        USING(order_id) 
GROUP BY (customer_id, product_id)) 
WHERE ROWNUM <= 5;

SELECT customer_id, name as customer_name, product_name as items_backordered FROM 
(SELECT customer_id, product_id 
FROM orders 
Left JOIN order_items 
        USING(order_id) 
where status='back ordered') 
LEFT JOIN customers 
        USING(customer_id) 
LEFT JOIN products 
     USING(product_id);

WITH 
CUS AS (SELECT customer_id from orders where status='fulfilled') 
SELECT DISTINCT customer_id FROM CUS 
ORDER BY CUSTOMER_ID ASC


select order_id,  
ROW_NUMBER() over(partition by product_id order by quantity, product_id) as item_id,  
product_id, quantity from order_items;

